# 对话历史接口文档

## 1. 接口概述

本文档描述了对话历史管理模块的所有接口，包括查询应用对话历史记录等功能。

**基础路径**: `/chatHistory`

**通用响应格式**:
```json
{
  "code": 0,
  "data": {},
  "message": "ok"
}
```

**状态码说明**:
- `0`: 成功
- `40000`: 请求参数错误
- `40100`: 未登录
- `40101`: 无权限
- `40400`: 请求数据不存在
- `40300`: 禁止访问
- `50000`: 系统内部异常
- `50001`: 操作失败

---

## 2. 需要登录的接口

### 2.1 分页查询应用对话历史（游标查询）

**接口地址**: `GET /chatHistory/app/{appId}`

**接口描述**: 查询指定应用的对话历史记录，采用游标分页方式，支持无限滚动加载。

**权限要求**: 需要登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| appId | Long | 是 | 应用ID（Path 参数） |
| pageSize | int | 否 | 每页数量（默认10） |
| lastCreateTime | LocalDateTime | 否 | 最后一条记录的创建时间（用于游标分页） |

**请求示例**:
```
GET /chatHistory/app/1001?pageSize=10
GET /chatHistory/app/1001?pageSize=10&lastCreateTime=2025-10-27T10:30:00
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Page\<ChatHistory\> | 分页数据 |
| message | String | 响应消息 |

**ChatHistory 对象结构**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 对话历史ID |
| message | String | 消息内容 |
| messageType | String | 消息类型（user/ai） |
| appId | Long | 应用ID |
| userId | Long | 创建用户ID |
| createTime | LocalDateTime | 创建时间 |
| updateTime | LocalDateTime | 更新时间 |
| isDelete | Integer | 是否删除（0-未删除，1-已删除） |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1001,
        "message": "创建一个待办事项列表",
        "messageType": "user",
        "appId": 1001,
        "userId": 1,
        "createTime": "2025-10-27T10:00:00",
        "updateTime": "2025-10-27T10:00:00",
        "isDelete": 0
      },
      {
        "id": 1002,
        "message": "好的，我已经为您创建了一个待办事项列表...",
        "messageType": "ai",
        "appId": 1001,
        "userId": 1,
        "createTime": "2025-10-27T10:01:00",
        "updateTime": "2025-10-27T10:01:00",
        "isDelete": 0
      },
      {
        "id": 1003,
        "message": "添加一个删除按钮",
        "messageType": "user",
        "appId": 1001,
        "userId": 1,
        "createTime": "2025-10-27T10:05:00",
        "updateTime": "2025-10-27T10:05:00",
        "isDelete": 0
      }
    ],
    "totalRow": 10,
    "pageNumber": 1,
    "pageSize": 10,
    "totalPage": 1
  },
  "message": "ok"
}
```

**失败响应示例**:
```json
{
  "code": 40100,
  "data": null,
  "message": "未登录"
}
```

---

## 3. 管理员接口（需要管理员权限）

### 3.1 管理员分页查询所有对话历史

**接口地址**: `POST /chatHistory/admin/list/page/vo`

**接口描述**: 管理员查询所有对话历史记录，支持多条件筛选。

**权限要求**: 管理员（admin）

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| pageNum | int | 否 | 当前页号（默认1） |
| pageSize | int | 否 | 每页数量（默认10） |
| sortField | String | 否 | 排序字段 |
| sortOrder | String | 否 | 排序方式（ascend/descend） |
| id | Long | 否 | 对话历史ID |
| appId | Long | 否 | 应用ID |
| userId | Long | 否 | 用户ID |
| messageType | String | 否 | 消息类型（user/ai） |

**请求示例**:
```json
{
  "pageNum": 1,
  "pageSize": 20,
  "sortField": "createTime",
  "sortOrder": "descend",
  "appId": 1001,
  "messageType": "user"
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Page\<ChatHistory\> | 分页数据 |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1001,
        "message": "创建一个待办事项列表",
        "messageType": "user",
        "appId": 1001,
        "userId": 1,
        "createTime": "2025-10-27T10:00:00",
        "updateTime": "2025-10-27T10:00:00",
        "isDelete": 0
      },
      {
        "id": 1002,
        "message": "添加一个删除按钮",
        "messageType": "user",
        "appId": 1001,
        "userId": 2,
        "createTime": "2025-10-27T10:05:00",
        "updateTime": "2025-10-27T10:05:00",
        "isDelete": 0
      }
    ],
    "totalRow": 100,
    "pageNumber": 1,
    "pageSize": 20,
    "totalPage": 5
  },
  "message": "ok"
}
```

**失败响应示例**:
```json
{
  "code": 40101,
  "data": null,
  "message": "无权限"
}
```

---

## 4. 认证和权限说明

### 4.1 认证机制

本系统采用 **Session** 机制进行用户认证：
- 用户登录成功后，系统会在 Session 中保存用户登录信息
- 后续请求通过 Cookie 携带 SessionId 来识别用户身份

### 4.2 权限控制

- **普通用户**: 只能查询自己参与的应用的对话历史
- **管理员**: 可以查询所有对话历史记录

### 4.3 权限拦截

如果用户访问需要权限的接口时：
- 未登录：返回 `40100` 错误码，提示"未登录"
- 权限不足：返回 `40101` 错误码，提示"无权限"

---

## 5. 数据模型说明

### 5.1 ChatHistory（对话历史实体）

| 字段名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 对话历史ID（主键） |
| message | String | 消息内容 |
| messageType | String | 消息类型（user/ai） |
| appId | Long | 应用ID |
| userId | Long | 创建用户ID |
| createTime | LocalDateTime | 创建时间 |
| updateTime | LocalDateTime | 更新时间 |
| isDelete | Integer | 是否删除（0-未删除，1-已删除） |

---

## 6. 业务规则说明

### 6.1 对话历史查询

- 用户只能查询自己参与的应用的对话历史
- 管理员可以查询所有对话历史
- 采用游标分页方式，支持无限滚动加载

### 6.2 消息类型

- `user`: 用户发送的消息
- `ai`: AI 回复的消息

### 6.3 游标分页

- 首次查询不需要传入 `lastCreateTime` 参数
- 后续查询传入上一页最后一条记录的 `createTime` 作为 `lastCreateTime`
- 按创建时间倒序排列，保证新消息在前

---

## 7. 常见问题

### 7.1 如何实现无限滚动加载？

1. 首次请求不传 `lastCreateTime` 参数，获取最新的对话记录
2. 获取最后一条记录的 `createTime`
3. 下次请求时传入该 `createTime` 作为 `lastCreateTime`，获取更早的记录
4. 重复步骤2-3，直到没有更多数据

### 7.2 为什么使用游标分页而不是传统分页？

游标分页的优势：
- 性能更好，不需要计算偏移量
- 数据一致性更好，不会因为数据变化导致重复或遗漏
- 更适合实时数据和无限滚动场景

### 7.3 messageType 有哪些值？

目前支持两种类型：
- `user`: 用户发送的消息
- `ai`: AI 回复的消息

---
