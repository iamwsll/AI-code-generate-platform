# 远程构建服务器部署指南

## 概述

为了降低主服务器的内存占用，项目支持将Vue项目的构建过程（`npm install` + `npm run build`）迁移到远程服务器执行。主服务器将生成的Vue项目打包发送到远程构建服务器，由远程服务器完成依赖安装和项目构建，然后将构建产物返回给主服务器。

## 架构说明

```
主服务器                        远程构建服务器
  |                                |
  | 1. 生成Vue项目代码               |
  |                                |
  | 2. 压缩项目为ZIP                |
  |                                |
  | 3. HTTP POST /api/build        |
  |---------------------------->  |
  |                               | 4. 解压项目
  |                               | 5. 执行 npm install
  |                               | 6. 执行 npm run build
  |                               | 7. 压缩dist目录
  |                               |
  | 8. 返回构建结果和产物            |
  |<----------------------------- |
  |                                |
  | 9. 保存dist目录                 |
  |                                |
```

## 远程构建服务器要求

### 硬件要求
- **内存**: 建议 4GB 以上（npm install 可能需要大量内存）
- **磁盘**: 建议 50GB 以上（用于存储项目文件和node_modules）
- **CPU**: 建议 2核 以上

### 软件要求
- **Node.js**: v18.x 或更高版本
- **npm**: v9.x 或更高版本
- **Python**: v3.x（某些npm包构建时需要）

## 远程构建服务器实现

远程构建服务器需要实现以下HTTP API接口：

### 1. 健康检查接口

```
GET /health
```

**响应示例：**
```json
{
  "status": "ok"
}
```

### 2. 构建接口

```
POST /api/build
Content-Type: application/json
X-API-Key: your-api-key (可选)
```

**请求体：**
```json
{
  "projectName": "vue-project-123456",
  "fileContent": "base64编码的项目ZIP文件内容"
}
```

**响应示例（成功）：**
```json
{
  "success": true,
  "message": "构建成功",
  "distContent": "base64编码的dist目录ZIP文件内容"
}
```

**响应示例（失败）：**
```json
{
  "success": false,
  "message": "npm install 失败: xxx"
}
```

## 简易Node.js实现示例

下面是一个简单的Node.js + Express实现示例：

```javascript
// server.js
const express = require('express');
const fs = require('fs-extra');
const path = require('path');
const { execSync } = require('child_process');
const AdmZip = require('adm-zip');

const app = express();
const PORT = 8124;
const WORK_DIR = path.join(__dirname, 'workspace');
const API_KEY = process.env.API_KEY || ''; // 从环境变量读取API Key

// 确保工作目录存在
fs.ensureDirSync(WORK_DIR);

// 解析JSON请求体（增加大小限制以支持大文件）
app.use(express.json({ limit: '100mb' }));

// API Key验证中间件（可选）
const validateApiKey = (req, res, next) => {
  if (API_KEY && req.headers['x-api-key'] !== API_KEY) {
    return res.status(401).json({ success: false, message: '未授权' });
  }
  next();
};

// 健康检查接口
app.get('/health', (req, res) => {
  res.json({ status: 'ok' });
});

// 构建接口
app.post('/api/build', validateApiKey, async (req, res) => {
  const { projectName, fileContent } = req.body;
  
  if (!projectName || !fileContent) {
    return res.status(400).json({ 
      success: false, 
      message: '缺少必要参数' 
    });
  }

  const projectDir = path.join(WORK_DIR, projectName);
  const zipPath = path.join(WORK_DIR, `${projectName}.zip`);
  
  try {
    console.log(`开始构建项目: ${projectName}`);
    
    // 1. 解码并保存ZIP文件
    const zipBuffer = Buffer.from(fileContent, 'base64');
    fs.writeFileSync(zipPath, zipBuffer);
    
    // 2. 解压项目
    const zip = new AdmZip(zipPath);
    zip.extractAllTo(projectDir, true);
    
    // 3. 执行 npm install
    console.log('执行 npm install...');
    execSync('npm install', { 
      cwd: projectDir,
      stdio: 'inherit',
      timeout: 600000 // 10分钟超时
    });
    
    // 4. 执行 npm run build
    console.log('执行 npm run build...');
    execSync('npm run build', { 
      cwd: projectDir,
      stdio: 'inherit',
      timeout: 300000 // 5分钟超时
    });
    
    // 5. 压缩dist目录
    const distDir = path.join(projectDir, 'dist');
    if (!fs.existsSync(distDir)) {
      throw new Error('dist目录不存在');
    }
    
    const distZip = new AdmZip();
    distZip.addLocalFolder(distDir);
    const distBuffer = distZip.toBuffer();
    const distBase64 = distBuffer.toString('base64');
    
    // 6. 清理临时文件
    fs.removeSync(projectDir);
    fs.removeSync(zipPath);
    
    // 7. 返回结果
    console.log(`项目构建成功: ${projectName}`);
    res.json({
      success: true,
      message: '构建成功',
      distContent: distBase64
    });
    
  } catch (error) {
    console.error(`构建失败: ${error.message}`);
    
    // 清理临时文件
    try {
      fs.removeSync(projectDir);
      fs.removeSync(zipPath);
    } catch (cleanupError) {
      console.error(`清理临时文件失败: ${cleanupError.message}`);
    }
    
    res.status(500).json({
      success: false,
      message: `构建失败: ${error.message}`
    });
  }
});

// 启动服务器
app.listen(PORT, () => {
  console.log(`远程构建服务器运行在端口 ${PORT}`);
  console.log(`工作目录: ${WORK_DIR}`);
});
```

### 安装依赖

```bash
npm init -y
npm install express fs-extra adm-zip
```

### 启动服务

```bash
# 不使用API Key
node server.js

# 使用API Key
API_KEY=your-secret-key node server.js
```

### 使用PM2管理（推荐）

```bash
# 安装PM2
npm install -g pm2

# 启动服务
pm2 start server.js --name remote-build-server

# 开机自启动
pm2 startup
pm2 save
```

## 主服务器配置

在主服务器的 `application.yml` 或 `application-local.yml` 中添加以下配置：

```yaml
remote:
  build:
    enabled: true # 启用远程构建
    server-url: http://your-remote-server:8124 # 远程服务器地址
    api-key: your-secret-key # API密钥（如果远程服务器配置了）
    connect-timeout: 30 # 连接超时（秒）
    read-timeout: 600 # 读取超时（秒），建议设置较大值
    max-retries: 3 # 最大重试次数
```

## 安全建议

1. **使用API Key**: 设置 `api-key` 防止未授权访问
2. **使用HTTPS**: 生产环境建议使用HTTPS加密通信
3. **网络隔离**: 将远程构建服务器放在内网，只允许主服务器访问
4. **定期清理**: 定期清理workspace目录下的临时文件
5. **资源限制**: 使用Docker或其他容器技术限制资源使用

## 监控建议

1. **磁盘空间监控**: 监控workspace目录的磁盘使用情况
2. **内存监控**: 监控npm install过程中的内存使用
3. **构建日志**: 保留构建日志便于排查问题
4. **性能指标**: 记录构建时间、成功率等指标

## 故障恢复

主服务器实现了自动故障恢复机制：

1. 如果远程构建服务不可用，会自动回退到本地构建
2. 如果远程构建失败，会自动回退到本地构建
3. 支持配置重试次数，提高构建成功率

## 性能优化建议

### 远程服务器端

1. **使用npm缓存**: 配置npm缓存目录，加速依赖安装
2. **使用镜像源**: 配置国内npm镜像（如淘宝镜像）
3. **并发限制**: 限制同时构建的项目数量，避免资源耗尽
4. **SSD存储**: 使用SSD存储提升读写速度

### 主服务器端

1. **异步构建**: 已支持异步构建，不阻塞主流程
2. **合理配置超时**: 根据实际情况调整超时时间
3. **监控服务状态**: 定期检查远程服务健康状态

## 故障排查

### 远程构建服务器无响应

检查：
- 远程服务器是否运行
- 网络连接是否正常
- 防火墙是否放行端口

### npm install 失败

检查：
- Node.js版本是否满足要求
- npm镜像源是否可用
- 磁盘空间是否充足
- 内存是否充足

### dist目录未生成

检查：
- npm run build是否执行成功
- package.json中的build脚本是否正确
- 查看构建日志排查具体错误

## 扩展功能

可以在远程构建服务器上实现更多功能：

1. **构建缓存**: 缓存node_modules，加速重复构建
2. **并发构建**: 支持多项目并发构建
3. **构建队列**: 实现构建队列管理
4. **构建历史**: 保存构建历史记录
5. **通知机制**: 构建完成后通知主服务器

## 参考资源

- [Node.js官方文档](https://nodejs.org/)
- [Express框架文档](https://expressjs.com/)
- [PM2进程管理器](https://pm2.keymetrics.io/)
