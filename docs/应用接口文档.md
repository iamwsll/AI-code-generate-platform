# 应用接口文档

## 1. 接口概述

本文档描述了应用管理模块的所有接口，包括应用创建、更新、删除、查询、部署、代码生成等功能。

**基础路径**: `/app`

**通用响应格式**:
```json
{
  "code": 0,
  "data": {},
  "message": "ok"
}
```

**状态码说明**:
- `0`: 成功
- `40000`: 请求参数错误
- `40100`: 未登录
- `40101`: 无权限
- `40400`: 请求数据不存在
- `40300`: 禁止访问
- `50000`: 系统内部异常
- `50001`: 操作失败

---

## 2. 需要登录的接口

### 2.1 创建应用

**接口地址**: `POST /app/add`

**接口描述**: 用户创建新应用，通过初始化 prompt 来定义应用。

**权限要求**: 需要登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| initPrompt | String | 否 | 应用初始化的 prompt |

**请求示例**:
```json
{
  "initPrompt": "创建一个待办事项管理应用"
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Long | 新创建的应用ID |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": 1001,
  "message": "ok"
}
```

---

### 2.2 更新应用

**接口地址**: `POST /app/update`

**接口描述**: 用户更新自己创建的应用名称，仅应用创建者和管理员可以更新。

**权限要求**: 需要登录，仅本人或管理员

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | Long | 是 | 应用ID |
| appName | String | 是 | 应用名称 |

**请求示例**:
```json
{
  "id": 1001,
  "appName": "我的待办事项应用"
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Boolean | 更新结果（true为成功） |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

**失败响应示例**:
```json
{
  "code": 40101,
  "data": null,
  "message": "无权限"
}
```

---

### 2.3 删除应用

**接口地址**: `POST /app/delete`

**接口描述**: 用户删除自己创建的应用，仅应用创建者和管理员可以删除。

**权限要求**: 需要登录，仅本人或管理员

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | Long | 是 | 应用ID |

**请求示例**:
```json
{
  "id": 1001
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Boolean | 删除结果（true为成功） |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 2.4 根据 ID 获取应用详情

**接口地址**: `GET /app/get/vo`

**接口描述**: 根据应用ID获取应用详细信息（包含用户信息）。

**权限要求**: 需要登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | Long | 是 | 应用ID（Query 参数） |

**请求示例**:
```
GET /app/get/vo?id=1001
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | AppVO | 应用详细信息 |
| message | String | 响应消息 |

**AppVO 对象结构**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| id | Long | 应用ID |
| appName | String | 应用名称 |
| cover | String | 应用封面URL |
| initPrompt | String | 应用初始化的 prompt |
| codeGenType | String | 代码生成类型（枚举） |
| deployKey | String | 部署标识 |
| deployedTime | LocalDateTime | 部署时间 |
| priority | Integer | 优先级 |
| userId | Long | 创建用户ID |
| createTime | LocalDateTime | 创建时间 |
| updateTime | LocalDateTime | 更新时间 |
| user | UserVO | 创建用户脱敏信息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "id": 1001,
    "appName": "待办事项应用",
    "cover": "https://example.com/cover.jpg",
    "initPrompt": "创建一个待办事项管理应用",
    "codeGenType": "html",
    "deployKey": "abc123",
    "deployedTime": "2025-10-27T14:30:00",
    "priority": 1,
    "userId": 1,
    "createTime": "2025-10-27T10:00:00",
    "updateTime": "2025-10-27T10:00:00",
    "user": {
      "id": 1,
      "userAccount": "testuser",
      "userName": "测试用户",
      "userAvatar": "https://example.com/avatar.jpg",
      "userProfile": "这是一个测试用户",
      "userRole": "user",
      "createTime": "2025-10-27T10:00:00"
    }
  },
  "message": "ok"
}
```

---

### 2.5 分页获取我的应用列表

**接口地址**: `POST /app/my/list/page/vo`

**接口描述**: 分页查询当前登录用户创建的应用列表。

**权限要求**: 需要登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| pageNum | int | 否 | 当前页号（默认1） |
| pageSize | int | 否 | 每页数量（默认10，最大20） |
| sortField | String | 否 | 排序字段 |
| sortOrder | String | 否 | 排序方式（ascend/descend） |
| appName | String | 否 | 应用名称（模糊查询） |
| codeGenType | String | 否 | 代码生成类型 |

**请求示例**:
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "sortField": "createTime",
  "sortOrder": "descend",
  "appName": "待办"
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Page\<AppVO\> | 分页数据 |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1001,
        "appName": "待办事项应用",
        "cover": "https://example.com/cover.jpg",
        "codeGenType": "html",
        "priority": 1,
        "userId": 1,
        "createTime": "2025-10-27T10:00:00"
      }
    ],
    "totalRow": 5,
    "pageNumber": 1,
    "pageSize": 10,
    "totalPage": 1
  },
  "message": "ok"
}
```

---

### 2.6 分页获取精选应用列表

**接口地址**: `POST /app/good/list/page/vo`

**接口描述**: 分页查询精选应用列表（priority 为特定值的应用）。

**权限要求**: 无需登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| pageNum | int | 否 | 当前页号（默认1） |
| pageSize | int | 否 | 每页数量（默认10，最大20） |
| sortField | String | 否 | 排序字段 |
| sortOrder | String | 否 | 排序方式（ascend/descend） |

**请求示例**:
```json
{
  "pageNum": 1,
  "pageSize": 10
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Page\<AppVO\> | 分页数据 |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1001,
        "appName": "精选应用1",
        "cover": "https://example.com/cover1.jpg",
        "codeGenType": "html",
        "priority": 10,
        "createTime": "2025-10-27T10:00:00"
      }
    ],
    "totalRow": 15,
    "pageNumber": 1,
    "pageSize": 10,
    "totalPage": 2
  },
  "message": "ok"
}
```

---

### 2.7 应用聊天生成代码（流式）

**接口地址**: `GET /app/chat/gen/code`

**接口描述**: 通过与AI聊天的方式生成应用代码，支持 Server-Sent Events (SSE) 流式响应。

**权限要求**: 需要登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| appId | Long | 是 | 应用ID（Query 参数） |
| message | String | 是 | 用户消息（Query 参数） |

**请求示例**:
```
GET /app/chat/gen/code?appId=1001&message=添加一个删除按钮
```

**响应格式**: Server-Sent Events (SSE) 流式数据

**响应示例**:
```
data: {"d":"添"}

data: {"d":"加"}

data: {"d":"删除"}

data: {"d":"功能"}

event: done
data: 
```

---

### 2.8 应用部署

**接口地址**: `POST /app/deploy`

**接口描述**: 部署应用，生成可访问的 URL。

**权限要求**: 需要登录

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| appId | Long | 是 | 应用ID |

**请求示例**:
```json
{
  "appId": 1001
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | String | 部署URL |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": "http://localhost:8123/api/static/abc123/",
  "message": "ok"
}
```

---

### 2.9 下载应用代码

**接口地址**: `GET /app/download/{appId}`

**接口描述**: 下载应用代码压缩包，仅应用创建者和管理员可以下载。

**权限要求**: 需要登录，仅本人或管理员

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| appId | Long | 是 | 应用ID（Path 参数） |

**请求示例**:
```
GET /app/download/1001
```

**响应**: 文件流（ZIP 压缩包）

**失败响应示例**:
```json
{
  "code": 40400,
  "data": null,
  "message": "应用代码不存在，请先生成代码"
}
```

---

## 3. 管理员接口（需要管理员权限）

### 3.1 管理员删除应用

**接口地址**: `POST /app/admin/delete`

**接口描述**: 管理员删除任意应用。

**权限要求**: 管理员（admin）

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | Long | 是 | 应用ID |

**请求示例**:
```json
{
  "id": 1001
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Boolean | 删除结果（true为成功） |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 3.2 管理员更新应用

**接口地址**: `POST /app/admin/update`

**接口描述**: 管理员更新应用信息，可以修改应用名称、封面、优先级等。

**权限要求**: 管理员（admin）

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | Long | 是 | 应用ID |
| appName | String | 否 | 应用名称 |
| cover | String | 否 | 应用封面URL |
| priority | Integer | 否 | 优先级（精选应用的标识） |

**请求示例**:
```json
{
  "id": 1001,
  "appName": "精选待办应用",
  "cover": "https://example.com/new-cover.jpg",
  "priority": 10
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Boolean | 更新结果（true为成功） |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": true,
  "message": "ok"
}
```

---

### 3.3 管理员分页获取应用列表

**接口地址**: `POST /app/admin/list/page/vo`

**接口描述**: 管理员分页查询所有应用列表，支持多条件筛选。

**权限要求**: 管理员（admin）

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| pageNum | int | 否 | 当前页号（默认1） |
| pageSize | int | 否 | 每页数量（默认10） |
| sortField | String | 否 | 排序字段 |
| sortOrder | String | 否 | 排序方式（ascend/descend） |
| id | Long | 否 | 应用ID |
| appName | String | 否 | 应用名称（模糊查询） |
| codeGenType | String | 否 | 代码生成类型 |
| priority | Integer | 否 | 优先级 |
| userId | Long | 否 | 创建用户ID |

**请求示例**:
```json
{
  "pageNum": 1,
  "pageSize": 10,
  "sortField": "createTime",
  "sortOrder": "descend",
  "priority": 10
}
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | Page\<AppVO\> | 分页数据 |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "records": [
      {
        "id": 1001,
        "appName": "待办事项应用",
        "cover": "https://example.com/cover.jpg",
        "codeGenType": "html",
        "priority": 10,
        "userId": 1,
        "createTime": "2025-10-27T10:00:00"
      }
    ],
    "totalRow": 50,
    "pageNumber": 1,
    "pageSize": 10,
    "totalPage": 5
  },
  "message": "ok"
}
```

---

### 3.4 管理员根据 ID 获取应用详情

**接口地址**: `GET /app/admin/get/vo`

**接口描述**: 管理员根据应用ID获取应用详细信息。

**权限要求**: 管理员（admin）

**请求参数**:

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| id | Long | 是 | 应用ID（Query 参数） |

**请求示例**:
```
GET /app/admin/get/vo?id=1001
```

**响应参数**:

| 参数名 | 类型 | 描述 |
|--------|------|------|
| code | int | 状态码 |
| data | AppVO | 应用详细信息 |
| message | String | 响应消息 |

**成功响应示例**:
```json
{
  "code": 0,
  "data": {
    "id": 1001,
    "appName": "待办事项应用",
    "cover": "https://example.com/cover.jpg",
    "codeGenType": "html",
    "priority": 10,
    "createTime": "2025-10-27T10:00:00"
  },
  "message": "ok"
}
```

---

## 4. 认证和权限说明

### 4.1 认证机制

本系统采用 **Session** 机制进行用户认证：
- 用户登录成功后，系统会在 Session 中保存用户登录信息
- 后续请求通过 Cookie 携带 SessionId 来识别用户身份

### 4.2 权限控制

- **普通用户**: 可以创建、更新、删除自己的应用
- **管理员**: 拥有所有权限，可以管理所有用户的应用

### 4.3 权限拦截

如果用户访问需要权限的接口时：
- 未登录：返回 `40100` 错误码，提示"未登录"
- 权限不足：返回 `40101` 错误码，提示"无权限"

---

## 5. 业务规则说明

### 5.1 应用创建

- 用户可以通过初始化 prompt 创建应用
- 系统会根据 prompt 生成应用代码

### 5.2 应用更新

- 普通用户只能更新应用名称
- 管理员可以更新应用的所有字段（名称、封面、优先级等）
- 更新时会自动设置编辑时间

### 5.3 应用删除

- 仅应用创建者和管理员可以删除应用
- 删除操作会将应用从数据库中移除

### 5.4 应用部署

- 部署后会生成唯一的 deployKey
- 通过 deployKey 可以访问已部署的应用
- 部署时会记录部署时间

### 5.5 代码生成

- 支持流式生成，实时返回生成过程
- 生成的代码会保存到服务器
- 可以下载生成的代码压缩包

### 5.6 精选应用

- 通过 priority 字段标识精选应用
- 精选应用会在首页展示

---

