# 远程构建功能实现总结

## 概述

本次改动实现了将Vue项目构建过程（npm install + npm run build）从主服务器迁移到远程服务器的功能，从而降低主服务器的内存占用。

## 架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        主服务器                                  │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  VueProjectBuilder                                      │    │
│  │  - buildProject()                                       │    │
│  │    ├─> 检查配置                                         │    │
│  │    ├─> 如果启用远程构建:                                │    │
│  │    │   └─> RemoteBuildService.buildProject()           │    │
│  │    │       ├─> 压缩项目为ZIP                            │    │
│  │    │       ├─> HTTP POST到远程服务器                    │    │
│  │    │       ├─> 接收构建产物                             │    │
│  │    │       └─> 解压dist目录                             │    │
│  │    └─> 否则使用本地构建                                 │    │
│  └────────────────────────────────────────────────────────┘    │
│                           │                                      │
└───────────────────────────┼──────────────────────────────────────┘
                            │ HTTP POST /api/build
                            │ {projectName, fileContent}
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    远程构建服务器                                │
│                                                                  │
│  ┌────────────────────────────────────────────────────────┐    │
│  │  Node.js + Express Server                              │    │
│  │  - POST /api/build                                      │    │
│  │    ├─> 解码并解压项目                                   │    │
│  │    ├─> 执行 npm install (高内存占用)                   │    │
│  │    ├─> 执行 npm run build                               │    │
│  │    ├─> 压缩dist目录                                     │    │
│  │    └─> 返回构建产物                                     │    │
│  │  - GET /health (健康检查)                               │    │
│  │  - GET /api/status (状态查询)                           │    │
│  │  - POST /api/cleanup (清理)                             │    │
│  └────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 实现的文件列表

### Java后端代码

1. **配置类**
   - `src/main/java/cn/iamwsll/aicode/config/RemoteBuildConfig.java`
     - 远程构建配置类，支持启用/禁用、服务器地址、API密钥等配置

2. **服务接口**
   - `src/main/java/cn/iamwsll/aicode/service/remote/RemoteBuildService.java`
     - 定义远程构建服务接口

3. **服务实现**
   - `src/main/java/cn/iamwsll/aicode/service/remote/impl/RemoteBuildServiceImpl.java`
     - 实现远程构建服务，包含压缩、HTTP通信、解压等功能

4. **修改的类**
   - `src/main/java/cn/iamwsll/aicode/core/builder/VueProjectBuilder.java`
     - 添加远程构建支持，保持向后兼容

5. **配置文件**
   - `src/main/resources/application.yml`
     - 添加远程构建配置项

### 远程构建服务器

6. **服务器实现**
   - `remote-build-server/server.js`
     - 完整的Node.js + Express服务器实现

7. **配置文件**
   - `remote-build-server/package.json`
     - Node.js依赖配置
   - `remote-build-server/.gitignore`
     - Git忽略配置

8. **Docker支持**
   - `remote-build-server/Dockerfile`
     - Docker镜像配置
   - `remote-build-server/docker-compose.yml`
     - Docker Compose配置

9. **文档**
   - `remote-build-server/README.md`
     - 快速开始指南

### 文档

10. **部署指南**
    - `docs/远程构建服务器部署指南.md`
      - 详细的部署指南，包含架构说明、API规范、部署方式、安全建议等

11. **主README更新**
    - `README.md`
      - 更新核心能力、扩展指引和常见问题部分

## 核心功能特性

### 1. 配置灵活
- 默认使用本地构建，无需强制启用远程构建
- 支持热配置，修改配置文件后重启即可生效
- 支持多种配置项：服务器地址、API密钥、超时时间、重试次数

### 2. 高可用性
- **自动故障恢复**: 远程服务不可用时自动回退到本地构建
- **重试机制**: 支持配置重试次数，提高构建成功率
- **健康检查**: 构建前检查远程服务可用性

### 3. 安全性
- 支持API Key认证，防止未授权访问
- 建议使用HTTPS加密通信（需配置反向代理）
- 支持网络隔离部署

### 4. 监控和日志
- 详细的构建日志，包含时间戳
- 构建时间统计（install时间、build时间、总时间）
- 支持查询服务器状态和工作目录

### 5. 易于部署
- 提供三种部署方式：直接运行、PM2管理、Docker容器
- 完整的Docker支持，一键部署
- 详细的部署文档和故障排查指南

## 配置示例

### 主服务器配置（application.yml）

```yaml
remote:
  build:
    enabled: false # 是否启用远程构建，默认false
    server-url: http://localhost:8124 # 远程构建服务器地址
    api-key: # API认证密钥（可选）
    connect-timeout: 30 # 连接超时（秒）
    read-timeout: 600 # 读取超时（秒）
    max-retries: 3 # 最大重试次数
```

### 启用远程构建

```yaml
remote:
  build:
    enabled: true
    server-url: http://your-build-server:8124
    api-key: your-secret-key
```

## 使用流程

### 1. 部署远程构建服务器

```bash
# 进入远程构建服务器目录
cd remote-build-server

# 方式一：使用Docker（推荐）
export API_KEY=your-secret-key
docker-compose up -d

# 方式二：使用PM2
npm install
pm2 start server.js --name remote-build-server
```

### 2. 配置主服务器

修改 `application-local.yml` 启用远程构建：

```yaml
remote:
  build:
    enabled: true
    server-url: http://your-build-server:8124
    api-key: your-secret-key
```

### 3. 重启主服务器

```bash
# 重启Spring Boot应用
./mvnw spring-boot:run
```

### 4. 测试

生成Vue项目时，系统会自动使用远程构建。可以查看主服务器日志确认：

```
[INFO] 开始构建 Vue 项目: /path/to/project
[INFO] 使用远程构建模式
[INFO] 开始远程构建项目: /path/to/project
[INFO] 压缩项目到: /tmp/project_xxx.zip
[INFO] 第 1 次尝试发送构建请求到远程服务器
[INFO] 远程构建成功，dist 目录: /path/to/project/dist
```

## API接口规范

### 健康检查
```
GET /health
Response: {"status": "ok"}
```

### 构建项目
```
POST /api/build
Headers: 
  Content-Type: application/json
  X-API-Key: your-api-key (可选)
Body:
{
  "projectName": "vue-project-123456",
  "fileContent": "base64编码的项目ZIP"
}
Response:
{
  "success": true,
  "message": "构建成功",
  "distContent": "base64编码的dist目录ZIP",
  "buildInfo": {
    "installDuration": "45.32秒",
    "buildDuration": "12.56秒",
    "totalDuration": "57.88秒"
  }
}
```

### 查询状态（可选）
```
GET /api/status
Headers: X-API-Key: your-api-key
Response:
{
  "workDir": "/app/workspace",
  "fileCount": 0,
  "files": []
}
```

### 清理工作目录（可选）
```
POST /api/cleanup
Headers: X-API-Key: your-api-key
Response: {"success": true, "message": "工作目录已清理"}
```

## 性能对比

### 本地构建
- **内存占用**: 主服务器需承担npm install的高内存占用（可能达到2-4GB）
- **并发能力**: 受主服务器内存限制，并发能力较差
- **稳定性**: 内存不足可能导致系统崩溃

### 远程构建
- **内存占用**: 主服务器只需处理文件传输，内存占用低
- **并发能力**: 可部署多个远程构建服务器，提高并发能力
- **稳定性**: 构建失败不影响主服务器稳定性
- **可扩展性**: 可根据负载动态增加构建服务器

## 安全建议

1. **使用API Key**: 防止未授权访问
2. **使用HTTPS**: 加密通信内容
3. **网络隔离**: 将远程构建服务器放在内网
4. **定期清理**: 清理workspace目录避免磁盘占满
5. **资源限制**: 使用Docker限制资源使用
6. **监控告警**: 监控服务器状态和磁盘空间

## 故障恢复机制

1. **远程服务不可用**: 自动回退到本地构建
2. **远程构建失败**: 自动回退到本地构建
3. **网络超时**: 支持重试机制
4. **部分失败**: 返回详细错误信息便于排查

## 监控指标

建议监控以下指标：

1. **构建成功率**: 远程构建和本地构建的成功率
2. **构建时间**: npm install时间、build时间、总时间
3. **服务可用性**: 远程服务的健康状态
4. **资源使用**: CPU、内存、磁盘使用情况
5. **错误日志**: 构建失败的原因分析

## 扩展建议

未来可以考虑以下扩展：

1. **构建队列**: 使用消息队列管理构建任务
2. **构建缓存**: 缓存node_modules加速构建
3. **并发构建**: 支持多项目并发构建
4. **构建历史**: 保存构建历史和日志
5. **通知机制**: 构建完成后通知主服务器
6. **负载均衡**: 部署多个构建服务器实现负载均衡

## 相关文档

- 详细部署指南: `docs/远程构建服务器部署指南.md`
- 快速开始: `remote-build-server/README.md`
- 主README: `README.md`

## 总结

本次实现完全解决了Vue项目构建时主服务器内存占用高的问题，通过将构建过程迁移到专门的远程服务器，不仅降低了主服务器的负担，还提高了系统的稳定性和可扩展性。同时保持了向后兼容性，默认使用本地构建，用户可以根据实际需求选择是否启用远程构建。

实现过程中注重代码质量和可维护性，提供了完整的文档、多种部署方式和故障恢复机制，确保系统的高可用性。
